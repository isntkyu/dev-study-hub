## 4.6 파이프라인 커넥션

여러개의 요청은 응답이 도착하기 전까지 큐에 쌓인다.

파이프라인 제약 사항

- http클라이언트는 커넥션이 지속 커넥션인지 확인하기 전까지는 파이프라인을 이어서는 안됨.
- http 응답은 요청 순서와 같게 와야한다. http 메시지는 순번이 매겨져 있지 않아서 순서 없이 응답이 오면 정렬시킬 방법이 없다.
- http 클라이언트는 커넥션이 언제 끊어지더라도 완료되지 않은 요청이 파이프라인에 있으면 언제든 다시 요청을 보낼 준비가 되어 있어야 한다.
  클라이언트가 지속 커넥션을 맺고나서 바로 10개의 요청을 보낸다고 해도 서버는 5개의 요청만 처리하고 커넥션을 임의로 끊을 수 있다.
- http클라이언트는 POST 요청같이 반복하면 문제가 있는 요청은 파이프라인을 통해 보내면 안된다. 에러가 발생하면 파이프라인 요청중 어떤 것들이 처리되었는지 알 방법이 없다.
  비멱등 메소드는 위험하다.

---

## 4.7 커넥션 끊기에 대한 미스터리

커넥션관리(언제 어떻게 끊는가) 는 명확한 기준이 없다.

---

### 4.7.4 우아한 커넥션 끊기

TCP 커넥션은 양방향이고 양쪽에는 데이터를 읽고 쓰기 위한 입력큐, 출력큐가 있다.
한쪽 출력큐에 있는 데이터는 다른쪽 입력큐에 보내질 것이다.

**전체끊기와 절반끊기**
애플리케이션은 TCP 입력채널과 출력채널중 한 개만 끊거나 둘 다 끊을 수 있다.
close()를 호출해서 둘 다 끊는 것을 전체끊기 라고 한다.

하나씩 개별적으로 끊으려면 shutdown()을 호출 하면 되고 이를 절반끊기 라고 한다.

**TCP 끊기와 리셋 에러**
단순한 HTTP 애플리케이션은 전체끊기많을 사용할 수 있다.
하지만 파이프라인 지속 커넥션을 사용할 때 에러 예방을 위해 절반 끊기를 사용해야 한다.
보통은 출력채널을 끊는 것이 안전하다.
